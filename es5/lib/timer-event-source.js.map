{"version":3,"sources":["lib/timer-event-source.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;AAEA;;;;IAIa,gB,WAAA,gB;;;AACX;;;AAGA,8BAAc;AAAA;;AAAA;;AAEZ,UAAK,iBAAL;AAFY;AAGb;;;;wCAEmB;AAAA;;AAClB,UAAM,mBAAmB,KAAK,gBAAL,CAAsB,IAAtB,CAA2B,IAA3B,CAAzB;AACA,iBAAW;AAAA,eAAM,OAAK,UAAL,CAAgB,gBAAhB,CAAN;AAAA,OAAX,EAAoD,OAAO,IAAI,IAAJ,GAAW,eAAX,EAA3D;AACD;;;+BAEU,gB,EAAkB;AAC3B,UAAM,OAAO,IAAI,IAAJ,EAAb;AACA;AACA,WAAK,OAAL,GAAe,KAAK,UAAL,KAAoB,CAApB,GAAwB,KAAK,eAAL,EAAxB,GAAiD,GAAjD,GAAuD,CAAvD,GAA2D,CAA1E;AACA,iBAAW,gBAAX,EAA6B,CAA7B;AACA,kBAAY,gBAAZ,EAA8B,IAA9B;AACD;;;uCAEkB;AAAA;;AACjB,WAAK,OAAL;AACA,iBAAW;AAAA,eAAM,OAAK,IAAL,CAAU,eAAV,CAAN;AAAA,OAAX,EAA6C,CAA7C;AACA,UAAI,KAAK,OAAL,GAAe,EAAf,KAAsB,CAA1B,EAA6B;AAAE;AAC7B,aAAK,OAAL,GAAe,CAAf;AACA,mBAAW;AAAA,iBAAM,OAAK,IAAL,CAAU,eAAV,CAAN;AAAA,SAAX,EAA6C,CAA7C;AACD;AACF","file":"lib/timer-event-source.js","sourcesContent":["import {EventEmitter} from 'events';\n\n/**\n * タイマーイベントエミッタ\n * TODO: 将来的にWebWorkerなどにして精度を担保する\n */\nexport class TimerEventSource extends EventEmitter {\n  /**\n   * constructor\n   */\n  constructor() {\n    super();\n    this._setInitialTimers();\n  }\n\n  _setInitialTimers() {\n    const _emitSecondEvent = this._emitSecondEvent.bind(this);\n    setTimeout(() => this._setTimers(_emitSecondEvent), 1000 - new Date().getMilliseconds());\n  }\n\n  _setTimers(_emitSecondEvent) {\n    const time = new Date();\n    // 9.999秒とかに最初に発火された時対策 初期誤差±500msにおさえる\n    this._second = time.getSeconds() - 1 + time.getMilliseconds() > 500 ? 1 : 0;\n    setTimeout(_emitSecondEvent, 0);\n    setInterval(_emitSecondEvent, 1000);\n  }\n\n  _emitSecondEvent() {\n    this._second++;\n    setTimeout(() => this.emit('second_change'), 0);\n    if (this._second % 60 === 0) { // イベントが遅延する場合を考えて\n      this._second = 0;\n      setTimeout(() => this.emit('minute_change'), 0);\n    }\n  }\n}\n"],"sourceRoot":"/source/"}